<!DOCTYPE html>
<html>

<head>

    <link rel="stylesheet" href="base.css" media="screen" />
    <link id="theme" rel="stylesheet" href="theme/dark.css" media="screen" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
    <script>
        $(document).ready(function () {

            // servlets.
            var comServlet = "command";
            var conServlet = "connection";
            var codServlet = "code";
            var synServlet = "sync";
            var resServlet = "result";

            // general.
            var output = "#terminal";
            var states = { default: "default", session: "session", live_session: "live_session", finished: "finished" };
            var state = states.default;
            var authKey = "";
            var ctrl = false;

            // default state.
            var line = "";
            var textBuffer = "";
            var cursor = '\u2588';
            var prompt = "> ";
            var keyPressExclude = ["Delete", "Enter"];
            var logo = "                        _________\n ____  ____  ____  ____ ______  /_____ ___   __\n||t ||||y ||||p ||||e ||_  __  / _  _ \\__ | / /\n||__||||__||||__||||__||/ /_/ /  /  __/__ |/ /\n|/__\\||/__\\||/__\\||/__\\|\\__,_/   \\___/ _____/\n"

            // live session state.
            var ezMode = true;
            var sessionProgress = null;
            var codeArray = null;
            var codeIndex = 0;
            var mistakes = 0;
            var progress = 0;

            // theme.
            var themes = ["dark", "light"];

            function resetSessionValues() {
                codeArray = null;
                codeIndex = 0;
                mistakes = 0;
                progress = 0;
            }

            function renderMOTD() {
                textBuffer = logo + "\nWelcome! to list all commands, type help.\n";
                renderText();
            }

            function renderText() {
                $(output).text(textBuffer + prompt + line + cursor);
            }

            function renderStatus() {
                $("#status").text(state + " " + authKey + " " + (codeArray === null ? null : codeArray.toString().replace(/,|\n/g, "").substring(0, 16)));
            }

            function buildCode(buffer) {
                for (let i = codeIndex; i < codeArray.length; i++) {
                    const char = codeArray[i];
                    buffer += char;
                }
                return buffer;
            }

            function buildProgressBar() {
                let buffer = "";
                if (sessionProgress != null) {
                    for (let i = 0; i < sessionProgress.length; i++) {
                        const user = sessionProgress[i];
                        buffer += user.name + " " + user.progress + " " + user.mistakes + "\n";
                    }
                }
                return buffer;
            }

            function renderLiveSession(output) {
                var buffer = buildProgressBar("") + "\n";
                buffer = buildCode(buffer);
                $(output).html(PR.prettyPrintOne(buffer));
            }

            function defaultKeyHandler(e) {
                switch (e.code) {
                    case "Delete":
                    case "Backspace":
                        line = line.substring(0, line.length - 1);
                        break;
                    case "Space":
                        line += e.key;
                        break;
                    case "Enter":
                        var argv = line.split(' ');
                        switch (argv[0]) {
                            case "cl":
                            case "clear":
                                textBuffer = "";
                                line = "";
                                break;
                            case "th":
                            case "theme":
                                $('#theme').each(function () {
                                    if (themes.includes(argv[1])) {
                                        this.href = "theme/" + argv[1] + ".css";
                                        feedback = "Set theme to " + argv[1] + ".";
                                    } else {
                                        feedback = "\"" + argv[1] + "\" is not a valid theme.";
                                    }
                                });
                                textBuffer += prompt + line + '\n' + feedback + '\n';
                                line = "";
                                break;
                            default:
                                $.post(comServlet, { command: line, key: authKey }, function (resp) {
                                    textBuffer += prompt + line + '\n';
                                    line = "";
                                    resp = JSON.parse(resp);
                                    if (authKey === "" && typeof resp.key !== "undefined") {
                                        // try to get a key if you dont have one yet
                                        authKey = resp.key;
                                    } else if (resp.key === "") {
                                        // drop the key when receiving logout signal
                                        authKey = "";
                                    }
                                    textBuffer += resp.message;
                                    renderText();
                                });
                                break;
                        }
                        break;
                    default:
                        break;
                }
                renderText();
            }

            function sessionKeyHandler(e) {
                var typedKey = e.key;
                var actualKey = codeArray[codeIndex];
                if (ctrl && typedKey == 'c') {
                    $.post(comServlet, { command: "leave", key: authKey }, function (resp) {
                        updateState();
                        resetSessionValues();
                        resp = JSON.parse(resp);
                        textBuffer += resp.message;
                        renderText();
                    });
                }
                if (ezMode) {
                    typedKey = typedKey.toLowerCase();
                    actualKey = actualKey.toLowerCase();
                }
                if (typedKey === actualKey) {
                    if (typedKey !== ' ') {
                        progress++;
                    }
                    codeIndex++;
                } else if (typedKey.length === 1) {
                    mistakes++;
                }
                if (e.key === ' ' || codeArray[codeIndex] === '\n' || codeArray[codeIndex] === '\t') {
                    while (codeArray[codeIndex] === ' ' || codeArray[codeIndex] === '\n' || codeArray[codeIndex] === '\t') {
                        codeIndex++;
                    }
                }
                renderLiveSession(output);
            }

            function buildResult(result) {
                var resultBuffer = "";
                for (let place in result) {
                    const entry = result[place];
                    resultBuffer += place + ". " + entry.name + " | " + entry.progress + " characters " + entry.mistakes + " mistakes\n";
                }
                return resultBuffer;
            }

            // get code if you are in a session lobby and don't have any code yet.
            function getCode() {
                if (codeArray === null) {
                    $.post(codServlet, { key: authKey }, function (resp) {
                        resp = JSON.parse(resp);
                        codeArray = resp.code.split("");
                    });
                }
            }

            function changeState(nextState) {
                var prevState = state;
                state = nextState;
                switch (state) {
                    case states.default:
                        // TODO: make reset work here
                        renderText();
                        break;
                    case states.session:
                        getCode();
                        break;
                    case states.live_session:
                        // prevent hyperactive users from screwing themselves
                        if (prevState === states.default) {
                            getCode();
                        }
                        break;
                    case states.finished:
                        $.post(resServlet, { key: authKey }, function (resp) {
                            resp = JSON.parse(resp);
                            if (!jQuery.isEmptyObject(resp)) {
                                textBuffer += "Finished session.\n";
                                textBuffer += buildResult(resp.result);
                                resetSessionValues();
                            } else {
                                alert("finishing session failed.");
                                changeState(states.default);
                            }
                        });
                        break;
                    default:
                        // prevent undefined states.
                        state = prevState;
                        break;
                }
            }

            function keepAlive() {
                if (authKey !== "") {
                    updateState();
                }
            }

            function updateState() {
                $.post(conServlet, { key: authKey }, function (resp) {
                    if (!jQuery.isEmptyObject(resp)) {
                        resp = JSON.parse(resp);
                        // update to state from server.
                        if (state !== resp.state) {
                            changeState(resp.state);
                        }
                    } else {
                        alert("connection failed.");
                        changeState(states.default);
                    }
                });
            }

            function syncProgress() {
                if (state === states.live_session) {
                    $.post(synServlet, { key: authKey, progress: progress, mistakes: mistakes }, function (resp) {
                        resp = JSON.parse(resp);
                        if (!jQuery.isEmptyObject(resp)) {
                            sessionProgress = resp.sessionProgress;
                            renderLiveSession(output);
                        } else {
                            alert("sync failed.");
                            changeState(states.default);
                        }
                    });
                }
            }

            $(document).keypress(function (e) {
                if (state !== states.live_session) {
                    for (let i = 0; i < keyPressExclude.length; i++) {
                        if (e.code === keyPressExclude[i]) {
                            return;
                        }
                    }
                    line += e.key;
                    renderText();
                }
            });

            $(document).keydown(function (e) {
                if (state === states.live_session) {
                    sessionKeyHandler(e);
                } else {
                    defaultKeyHandler(e);
                }
                if (e.keyCode == 32) {
                    return false;
                } else if (e.keyCode == 17) {
                    ctrl = true;
                }
            });

            $(document).keyup(function (e) {
                if (e.keyCode == 17) {
                    ctrl = false;
                }
            });

            setInterval(() => {
                keepAlive();
                syncProgress();
                renderStatus();
            }, 1000);

            renderMOTD();
            renderText();

        });

    </script>
</head>

<body>
    <div>
        <code id=terminal></code><br>
        <code id=status></code>
    </div>
</body>

</html>