<!DOCTYPE html>
<html>

<head>

    <link rel="stylesheet" href="base.css" media="screen" />
    <link rel="stylesheet" href="desert.css" media="screen" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
    <script>
        $(document).ready(function () {

            // servlets.
            var comServlet = "command";
            var conServlet = "connection";
            var codServlet = "code";
            var synServlet = "sync";
            var resServlet = "result";

            // general.
            var output = "#terminal";
            var states = { default: "default", session: "session", live_session: "live_session", finished: "finished" };
            var state = states.default;
            var authKey = "";

            // default state.
            var line = "";
            var textBuffer = "";
            var cursor = '\u2588';
            var prompt = "> ";
            var keyPressExclude = ["Delete", "Enter"];

            // live session state.
            var ezMode = true;
            var sessionProgress = null;
            var codeArray = null;
            var codeIndex = 0;
            var mistakes = 0;
            var progress = 0;

            function resetSessionValues() {
                codeArray = null;
                codeIndex = 0;
                mistakes = 0;
                progress = 0;
            }

            function renderText() {
                $(output).text(textBuffer + prompt + line + cursor);
            }

            function renderStatus() {
                $("#status").text(state + " " + authKey + " " + (codeArray === null ? null : codeArray.toString().replace(/,|\n/g, "").substring(0, 16)));
            }

            function buildCode(buffer) {
                for (let i = codeIndex; i < codeArray.length; i++) {
                    const char = codeArray[i];
                    buffer += char;
                }
                return buffer;
            }

            function buildProgressBar() {
                let buffer = "";
                if (sessionProgress != null) {
                    for (let i = 0; i < sessionProgress.length; i++) {
                        const user = sessionProgress[i];
                        buffer += user.name + " " + user.progress + " " + user.mistakes + "\n";
                    }
                }
                return buffer;
            }

            function renderLiveSession(output) {
                var buffer = buildProgressBar("") + "\n";
                buffer = buildCode(buffer);
                $(output).html(PR.prettyPrintOne(buffer));
            }

            function defaultKeyHandler(e) {
                switch (e.code) {
                    case "Delete":
                    case "Backspace":
                        line = line.substring(0, line.length - 1);
                        break;
                    case "Space":
                        line += e.key;
                        break;
                    case "Enter":
                        $.post(comServlet, {
                            command: line,
                            key: authKey
                        }, function (resp) {
                            textBuffer += prompt + line + '\n';
                            line = "";
                            resp = JSON.parse(resp);
                            if (authKey === "" && typeof resp.key !== "undefined") {
                                // try to get a key if you dont have one yet
                                authKey = resp.key;
                            } else if (resp.key === "") {
                                // drop the key when receiving logout signal
                                authKey = "";
                            }
                            textBuffer += resp.message;
                            renderText();
                        });
                        break;
                    default:
                        break;
                }
                renderText();
            }

            function sessionKeyHandler(e) {
                var typedKey = e.key;
                var actualKey = codeArray[codeIndex];
                if (ezMode) {
                    typedKey = typedKey.toLowerCase();
                    actualKey = actualKey.toLowerCase();
                }
                if (typedKey === actualKey) {
                    if (typedKey !== ' ') {
                        progress++;
                    }
                    codeIndex++;
                } else if (typedKey.length === 1) {
                    mistakes++;
                }
                if (e.key === ' ' || codeArray[codeIndex] === '\n' || codeArray[codeIndex] === '\t') {
                    while (codeArray[codeIndex] === ' ' || codeArray[codeIndex] === '\n' || codeArray[codeIndex] === '\t') {
                        codeIndex++;
                    }
                }
                renderLiveSession(output);
            }

            function buildResult(result) {
                var resultBuffer = "";
                for (let place in result) {
                    const entry = result[place];
                    resultBuffer += place + ". " + entry.name + " | " + entry.progress + " characters " + entry.mistakes + " mistakes\n";
                }
                return resultBuffer;
            }

            function changeState(nextState) {
                var prevState = state;
                state = nextState;
                switch (state) {
                    case states.default:
                        // TODO: make reset work here
                        renderText();
                        break;
                    case states.session:
                        // get code if you are in a session lobby and don't have any code yet.
                        if (codeArray === null) {
                            $.post(codServlet, { key: authKey }, function (resp) {
                                resp = JSON.parse(resp);
                                codeArray = resp.code.split("");
                            });
                        }
                        break;
                    case states.live_session:
                        break;
                    case states.finished:
                        $.post(resServlet, { key: authKey }, function (resp) {
                            resp = JSON.parse(resp);
                            if (!jQuery.isEmptyObject(resp)) {
                                textBuffer += "Finished session.\n";
                                textBuffer += buildResult(resp.result);
                                resetSessionValues();
                            } else {
                                alert("finishing session failed.");
                                changeState(states.default);
                            }
                        });
                        break;
                    default:
                        // prevent undefined states.
                        state = prevState;
                        break;
                }
            }

            function keepAlive() {
                if (authKey !== "") {
                    $.post(conServlet, { key: authKey }, function (resp) {
                        if (!jQuery.isEmptyObject(resp)) {
                            resp = JSON.parse(resp);
                            // update to state from server.
                            if (state !== resp.state) {
                                changeState(resp.state);
                            }
                        } else {
                            alert("connection failed.");
                            changeState(states.default);
                        }
                    });
                }
            }

            function syncProgress() {
                if (state === states.live_session) {
                    $.post(synServlet, { key: authKey, progress: progress, mistakes: mistakes }, function (resp) {
                        resp = JSON.parse(resp);
                        if (!jQuery.isEmptyObject(resp)) {
                            sessionProgress = resp.sessionProgress;
                            renderLiveSession(output);
                        } else {
                            alert("sync failed.");
                            changeState(states.default);
                        }
                    });
                }
            }

            $(document).keypress(function (e) {
                if (state !== states.live_session) {
                    for (let i = 0; i < keyPressExclude.length; i++) {
                        if (e.code === keyPressExclude[i]) {
                            return;
                        }
                    }
                    line += e.key;
                    renderText();
                }
            });

            $(document).keydown(function (e) {
                if (state === states.live_session) {
                    sessionKeyHandler(e);
                } else {
                    defaultKeyHandler(e);
                }
            });

            setInterval(() => {
                keepAlive();
                syncProgress();
                // renderStatus();
            }, 1000);

            renderText();

        });

        // space bar has been defused
        $(document).keydown(function (e) {
            if (e.which == 32) {
                return false;
            }
        });

    </script>
</head>

<body>
    <div>
        <code id=terminal></code><br>
        <code id=status></code>
    </div>
</body>

</html>