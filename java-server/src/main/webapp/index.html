<!DOCTYPE html>
<html>

<head>

    <link rel="stylesheet" href="base.css" media="screen" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        $(document).ready(function () {

            var commandServlet = "command";
            var output = "#terminal";
            var line = "";
            var buffer = "";
            var cursor = '\u2588';
            var prompt = "> ";
            var keyPressExclude = ["Delete", "Enter"];
            var authKey = "";

            function renderText() {
                $(output).text(buffer + prompt + line + cursor);
            }

            renderText();

            $(document).keypress(function (e) {
                for (let i = 0; i < keyPressExclude.length; i++) {
                    if (e.code === keyPressExclude[i]) {
                        return;
                    }
                }
                line += e.key;
                renderText();
            });

            $(document).keydown(function (e) {
                switch (e.code) {
                    case "Delete":
                    case "Backspace":
                        line = line.substring(0, line.length - 1);
                        break;
                    case "Space":
                        line += e.key;
                        break;
                    case "Enter":
                        $.post(commandServlet, {
                            command: line,
                            key: authKey
                        }, function (resp) {
                            buffer += prompt + line + '\n';
                            line = "";
                            resp = JSON.parse(resp);
                            if (authKey === "" && typeof resp.key !== "undefined") {
                                // try to get a key if you dont have one yet
                                authKey = resp.key;
                            } else if (resp.key === "") {
                                // drop the key when receiving logout signal
                                authKey = "";
                            }
                            buffer += resp.message;
                            $("#status").text(e.key + " " + e.which + " " + authKey);
                            renderText();
                        });
                        break;
                    default:
                        break;
                }
                $("#status").text(e.key + " " + e.which + " " + authKey);
                renderText();
            });

        });

        // space bar has been defused
        $(document).keydown(function (e) {
            if (e.which == 32) {
                return false;
            }
        });

    </script>
</head>

<body>
    <div>
        <code id=terminal></code><br>
        <code id=status></code>
    </div>
</body>

</html>